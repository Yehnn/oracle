# 存储过程

## 实验介绍

### 实验内容



### 实验知识点

+ ​




## 存储过程简介

一个过程是可以通过名字调用的一组 PL/SQL 语句。它将复杂的业务规则从应用程序中分离出来交给数据库，应用程序只需要调用存储过程获取返回的结果就行了。这种方式将复杂的数据处理交给了服务器处理，大大提高了效率，并且后期维护会很容易，因为不用在大量的应用程序代码中修改，而只需要修改存储过程。

## 创建存储过程

创建存储过程必须拥有 `CREATE PROCEDURE` 系统权限或者 `CREATE ANY PROCEDURE` 系统权限。后者用于在其他用户模式中创建存储过程。

创建存储过程的具体语法可参见 [创建存储过程](https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sqlrf/CREATE-PROCEDURE.html#GUID-771879D8-BBFD-4D87-8A6C-290102142DA3) 。我们可以创建无参和有参存储过程，下面从实践中去体会它们的实际运用。

### 创建无参存储过程

接下来我们来创建一个简单的存储过程，实现打印 `hello world` 。

首先确定 SERVEROUTPUT 是否打开：

```sql
SQL> show serveroutput;

--如果显示未打开，则使用如下方式打开
SQL> set serveroutput on;
```

接着创建一个名为 `pro1` 的存储过程：

```plsql
CREATE PROCEDURE pro1     --创建无参存储过程
AS
BEGIN
	DBMS_OUTPUT.PUT_LINE('hello world');
END;
/
```

我们可以查看是否创建成功：

```plsql
select * from user_source where name='PRO1';
```

> `user_source` 是查询当前用户的存储过程。如果要查看所有的存储过程使用 `all_source` 。

下面执行一下我们创建的这个存储过程：

```plsql
exec pro1;

--或者使用如下方式执行
BEGIN
pro1;
END;
/
```

输出结果：

```
PL/SQL 过程已成功完成。
hello world
```

### 创建有参存储过程

创建有参的存储过程的概念就像其他程序语言的创建带参函数，以便于数据的输入输出。创建存储过程中定义的参数有输入，输出，输入输出三种参数。下面通过实践分别学习创建带各种参数的存储过程。

#### 输入类型参数

我们之前有写过一个根据键盘输入的学生编号查找学生姓名的 PL/SQL 程序。在这里我们调用存储过程，向其传入学生编号，返回学生姓名的方式实现姓名查询。

```plsql
CREATE PROCEDURE PRO_NAME(arg_id IN NUMBER)
AS
  v_sname VARCHAR2(20);    --接收学生姓名
BEGIN
  SELECT s_name INTO v_sname FROM student WHERE s_id=arg_id; --把查询出来的值赋给变量 v_sname
  DBMS_OUTPUT.put_line('student''s name is : ' || v_sname);
END;
/
```

> `IN` 代表定义的参数是输入参数，是默认的，可以省略 IN。`NUMBER` 是输入参数的类型。
>
> `AS` 后面声明了一个变量用来接收学生姓名，用于打印出查询出来的学生姓名。
>
> `BEGIN` 和 `END` 之间是执行的查询操作。

查询学生编号为 1001 的学生姓名：

```plsql
exec PRO_NAME(1001);
```

输出结果：

```plsql
PL/SQL 过程已成功完成。
student's name is : shiyanlou1001
```

#### 输出类型参数

如果有其他存储过程想使用查询出来的学生姓名怎么办呢。这个时候就需要在被调用的存储过程中定义输出参数，将接收学生姓名的参数传出来供其他存储过程使用。首先我们创建一个被调用的存储过程，它能根据传入的学生编号，将学生姓名传出。

```plsql
CREATE PROCEDURE PRO_NAME2(arg_id IN NUMBER,arg_name OUT VARCHAR2)
AS
BEGIN
  SELECT s_name INTO arg_name FROM student WHERE s_id=arg_id;   --把查询出来的值给输入参数 arg_name
END;
/
```

> `OUT` 代表定义的参数是输出参数。

然后创建一个存储过程，它调用上面的存储过程，然后将学生姓名打印出来：

```plsql
CREATE PROCEDURE PRO_GETNAME
AS
  v_name student.s_name%TYPE;   --接收学生姓名
BEGIN
  PRO_NAME2(1001,v_name);     --调用存储过程 PRO_NAME2，将传出的学生姓名给变量 v_name
  DBMS_OUTPUT.put_line('student''s name is : ' || v_name);  --打印出变量 v_name 的值
END;
/
```

执行存储过程 PRO_GETNAME 及其输出结果：

```plsql
SQL> exec pro_getname;

PL/SQL 过程已成功完成。
student's name is : shiyanlou1001
```

#### 输入输出类型参数

顾名思义，也就是既可以输入也可以输出。例如我们根据学生编号查询对应的学生年龄。首先创建被调用的存储过程：

```plsql
CREATE PROCEDURE PRO_NAME3(arg_id_age IN OUT NUMBER)  --定义输入输出参数，它既可以传入学生编号，又可以传出学生年龄
AS
BEGIN
	--根据学生编号查询学生年龄
  SELECT s_age INTO arg_id_age FROM student WHERE s_id=arg_id_age; 
END;
/
```

然后创建一个存储过程调用上面的存储过程，查询学生编号为 1001 的学生年龄。

```plsql
CREATE PROCEDURE PRO_GETAGE
AS
  v_id_age student.s_age%TYPE;  
BEGIN
  v_id_age:=1001;     --学生编号为 1001
  PRO_NAME3(v_id_age);  --调用 PRO_NAME3 存储过程，查询出 1001 学生的年龄，再给变量 v_id_age
  DBMS_OUTPUT.put_line('student''s age is : ' || v_id_age);  --打印出学生年龄
END;
/
```

执行存储过程以及输出结果：

```plsql
SQL> exec pro_getage;

PL/SQL 过程已成功完成。
student's age is : 10
```

> **注：编译存储过程时难免遇到各种错误，此时可以使用 `show errors procedure <procedure_name>` 查看更详细的错误信息。**

### 存储过程中使用 DDL 语句

上面创建的存储过程中使用的都是 DML 语句，如果要使用 DDL 语句，比如创建表等，不能像使用 DML 语句一样直接使用，而需要加上 `EXECUTE IMMEDIATE` 。

例如创建一个表，其中包含学生姓名和学生平均成绩。

```plsql
CREATE PROCEDURE PRO_GRADE
AS
BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE stu_grade AS select s_name,avg(grade) avg_grade from student join sc using(s_id) group by s_name order by s_name';   --创建表
END;
```

执行存储过程以及查询表 stu_grade 中的内容：

```plsql
exec pro_grade;
select * from stu_grade;
```




























## 总结

