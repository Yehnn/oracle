http://study.163.com/course/introduction.htm?courseId=1002900007#/courseDetail?tab=1 章节 11

# 表

## 实验介绍

### 实验内容



### 实验知识点

- 常用数据类型
- 表的创建
- 表的重命名
- 截断表
- 表的复制
- 表的删除
- 修改表的结构

## 常用数据类型

以下是介绍一些我们最常用的数据类型：

- 字符串：使用 `VARCHAR2` 描述（其他数据库用 VARCHAR）。例如姓名，地址等。
- 数字：使用 `NUMBER` 描述。如果要描述小数则使用 `NUMBER(p,s)` ，其中 `s` 是小数位（scale），`p-s` 是整数位，例如 `number(4,2)` 代表存储小数位数为 2，总长度最多为 4 的浮点数。也可以用 `INT` 描述整数，`FLOAT` 描述小数。
- 日期：使用 `DATE` 描述。Oracle 里的 DATE 包含有日期时间。其他数据库一般 DATE 只是日期，DATETIME 才表示日期时间。
- 大文本数据：使用 `GLOB` 描述。最多可以保存 `4G` 的文字信息。

想了解更多数据类型可参考[Oracle SQL 数据类型](https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sqlrf/Data-Types.html#GUID-A3C0D836-BADB-44E5-A5D4-265BA5968483)

## 创建表

### 普通创建

语法：

```sql
CREATE TABLE 表名称(
	列名称		类型		[DEFAULT 默认值]
	列名称		类型		[DEFAULT 默认值]
	...
)
```

例如：

注：前面的 `SQL>` 不用输入，只是为了说明是在 SQL 命令行输入内容。

```sql
SQL> CREATE TABLE student(
  id		NUMBER,
  name		VARCHAR2(20),
  age		number(3),
  birthday	DATE	DEFAULT SYSDATE,
  note		CLOB
);
```

查看是否已经创建好 student 表：

```sql
SQL> select * from tab where tname='STUDENT';
```

查看 student 表结构：

```sql
SQL> desc student;
```

我们可以向其中插入数据：

```sql
SQL> INSERT INTO student(id,name,age,birthday,note) VALUES (1,'syl',19,TO_DATE('1999-01-01','yyyy-mm-dd'),'note test');
SQL> INSERT INTO student(id,name,age,birthday,note) VALUES (2,'lou',21,TO_DATE('1997-01-01','yyyy-mm-dd'),'note test');
```

查看我们插入的数据：

```sql
SQL> select * from student;
```

### 通过查询结果创建

例如我们查询出 student 表中 name 字段值为 syl 的记录，通过查询结果创建一个 名叫 syl_stu 的表。

```sql
SQL> create table syl_stu as select * from student where name='syl';
SQL> select * from syl_stu;
```

## 表的重命名

```sql
SQL> RENAME student TO stu;
```

我们使用数据字典查询一个用户全部的数据表，可以发现表已经被更名：

```sql
SQL> select * from user_tables;
```

列出数据库表对象的全部信息内容，例如名称，存储情况等。

>  数据字典：记录所有对象的信息。
>
>  - 用户级别：user_*，指一个用户可以使用的数据字典。
>  - 管理员级别：dba_*，指由数据库管理员使用的数据字典。
>  - 全部级别：all_* ，指不管是用户还是管理员都可以使用。

## 修改表结构

首先我们使用 `desc` 来查看表的结构。

```sql
SQL> desc stu;
名称       空值 类型           
-------- -- ------------ 
ID          NUMBER       
NAME        VARCHAR2(20) 
AGE         NUMBER(3)    
BIRTHDAY    DATE         
NOTE        CLOB      
```

接下来我们来修改表的结构。

### 增加列 （ADD）

例一：为 `stu` 表增加一列 `address` ，设默认值为 none。

```sql
SQL> alter table stu add(address varchar2(50) default 'none');
```

然后查看表中数据会发现多了 address 列，并且值为 none：

```sql
SQL> select * from stu;
```

例二：为 `stu` 表增加一列 `email` ，不设默认值。

```sql
SQL> alter table stu add(email varchar2(50));
```

再次查看表，会发现多了 email 列，并且为 null。

```sql
SQL> select * from stu;
```

### 修改表中的数据列 （MODIFY）

例一：修改 `stu` 表的 `name` 列的类型为 `varchar2(30)` 。

```sql
SQL> alter table stu modify (name varchar2(30));
```

例二：修改 `stu` 表的 `email` 列的默认值为 `no email` 。

```sql
SQL> alter table stu modify (email default 'no email');
```

注意：虽然这里我们设置了默认值，但是以前插入的数据的 `email` 列的值仍然是 null，只有我们新插入的数据的 `email` 列的值才默认为 `no email` ，如下所示：

```sql
SQL> select * from stu;
SQL> INSERT INTO stu(id,name,age,birthday,note) VALUES (3,'plus',19,TO_DATE('1999-01-01','yyyy-mm-dd'),'note test');
SQL> select * from stu;
```

### 重命名列（RENAME COLUMN）

例：将 `address` 列的名称改为 `saddress` 。

```sql
SQL> alter table stu rename column address to saddress;
```

重命名列还有一个作用就是在要删除一个列的时候，用来确认是否有用户或应用程序正在使用此列，如果有的话，就会报错。

### 删除列 （DROP）

例：将 `saddress` 列删除。

```sql
SQL> alter table stu drop (saddress);

或者使用
SQL> alter table stu drop column saddress;
```

在删除一列的时候如果数据太多，通常需要一定时间，如果想快速使用户或应用程序不能访问某些列的时候，可以使用 `unused` 标记列。例如下面我们标记 `email` 列：

```sql
SQL> alter table stu set unused (email);
```

标记过后使用 `desc stu` 查看会发现没有显示 `email` 列，但是它并没有真正被删除，执行下面的语句可以删除所有被 `unused` 标记的列。

```sql
SQL> alter table stu drop unused columns;
```

### 复制表结构

复制表结构类似于用查询创建表，只是修改了 `where` 条件。例如，我们要复制 `stu`  的表结构。

```sql
SQL> create table stu_cp as select * from stu where 1=2;
```

该语句只是复制了结构，并没有复制其数据：

```sql
SQL> desc stu_cp;
SQL> select * from stu_cp;
```

## 删除表内容

首先我们来进行普通的删除操作。

```sql
SQL> commit; 
SQL> delete from stu;
```

查看表内容会发现已经被清空。但是在我们执行 `rollback` 回滚操作过后会发现数据又被恢复：

```sql
SQL> rollback;
SQL> select * from stu;
```

> rollback 会恢复到上一次 commit 的数据。

上面的删除操作并没有立即将表所占的资源（约束，索引等）立即释放掉，如果想要完全删除，就需要使用 `truncate` ，也叫做截断表的操作。例如：

```sql
SQL> truncate table stu;
```

这个时候再执行回滚操作，会发现数据无法恢复：

```sql
SQL> rollback;
SQL> select * from stu;
```

## 表的删除

例如我们要删除 `syl_stu` 这张表，可以使用如下命令：

```sql
SQL> drop table syl_stu;
```

> 注意：如果删除的表是含有约束的父表的话，将会报错。此时需要使用 `drop table <table_name> cascade constraints` 删除。

## 闪回技术

闪回操作也就是一个恢复操作，当我们不小心使用 `drop table` 删除了一张表的时候，实际上和 windows 删除文件类似，这个表被放到了回收站中，并且为了标记出回收站的内容不是空的，会在表的数据字典中生成 `BIN$` 开头的内容。我们可以使用闪回闪回技术 `FLASHBACK` 进行恢复。

### 查看回收站内容

```sql
SQL> show recyclebin;
select * from user_recyclebin;
```

> 注意：
>
> - 回收站功能是默认启用的，如果想要修改，可以设置初始参数 `RECYCLEBIN` 的值为 `OFF` 。不建议把回收站功能关掉。
> - `SYSTEM` 表空间没有回收站功能。

### 闪回某表

也就是恢复某表。使用如下语法：

```sql
SQL> flashback table <table name> to before drop;
```

### 彻底删除某表

语法：

```sql
SQL> drop table <table name> purge;
```

> 彻底删除过后，表所占用的资源会被全部释放。

### 清空回收站

清空当前用户回收站，语法：

```sql
SQL> purge recyclebin;
```

清空所有用户回收站，语法：

```sql
SQL> purge dba_recyclebin;
```

> 注意：需要 DBA 权限。

想了解更多可参考 [FLASHBACK TABLE](https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sqlrf/FLASHBACK-TABLE.html#GUID-FA9AF2FD-2DAD-4387-9E62-14AFC26EA85C)

## 总结

